---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import PostCard from "../../components/PostCard.astro";
import MarkdownPageLayout from "../../layouts/MarkdownPage.astro";

export const prerender = true;

// Define the type for the props we receive from getStaticPaths
interface Props {
	posts: CollectionEntry<"posts">[];
	tagName: string;
}

export async function getStaticPaths() {
	const allPosts = await getCollection("posts");
	const tagSet = new Set<string>();

	// 1. Collect all unique, normalized tags
	allPosts.forEach((post) => {
		if (post.data.tags) {
			post.data.tags.forEach((tag) => {
				tagSet.add(tag.toLowerCase());
			});
		}
	});

	// 2. Create a path for every unique tag
	return Array.from(tagSet).map((tag) => {
		// Find all posts that include this specific tag
		const filteredPosts = allPosts.filter((post) =>
			post.data.tags?.map((t) => t.toLowerCase()).includes(tag),
		);

		// Sort posts by date for display (newest first)
		filteredPosts.sort(
			(a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime(),
		);

		return {
			params: { tag: tag },
			props: { posts: filteredPosts, tagName: tag },
		};
	});
}

const { posts, tagName } = Astro.props;
const capitalizedTagName = tagName.charAt(0).toUpperCase() + tagName.slice(1);
---

<MarkdownPageLayout 
    frontmatter={{ 
        title: `Topic: #${capitalizedTagName}`, 
        description: `All posts related to ${capitalizedTagName}.` 
    }}
>
    <h1 class="text-center mb-4">Topic: 
        <span class="text-brand-primary">#{capitalizedTagName}</span>
    </h1>

    <p class="text-center text-brand-text-sub text-lg mb-12">
        Found <strong>{posts.length}</strong> article{posts.length !== 1 ? 's' : ''} on this topic.
    </p>

    <section class="grid grid-cols-1 gap-8">
        {posts.map(post => (
            <PostCard 
                title={post.data.title}
                slug={post.slug}
                description={post.data.description}
                publishDate={post.data.publishDate}
            /> 
        ))}
    </section>

</MarkdownPageLayout>
